#!/bin/bash
# while true; do sleep 1000; done
mysql="mysql -u root -p$SQL_ROOT_PASSWORD -h localhost"
if [ -d "/var/lib/mysql/${SQL_DATABASE}" ]
then
    echo "all good"
else

    service mariadb start
    sleep 1
    $mysql <<- EOF
        DELETE FROM mysql.user WHERE user NOT IN ('mariadb.sys', 'root') OR host NOT IN ('localhost');
        ALTER USER 'root'@'localhost' IDENTIFIED BY '${SQL_ROOT_PASSWORD}';
        GRANT ALL ON *.* TO 'root'@'localhost' WITH GRANT OPTION ;
        DROP DATABASE IF EXISTS test ;
        CREATE DATABASE IF NOT EXISTS \`${SQL_DATABASE}\`;
        CREATE USER IF NOT EXISTS '${SQL_USER}'@'%' IDENTIFIED BY '${SQL_PASSWORD}';
        GRANT ALL ON \`${SQL_DATABASE}\`.* TO '${SQL_USER}'@'%' IDENTIFIED BY '${SQL_PASSWORD}';
        FLUSH PRIVILEGES;
EOF

fi
sleep 1
mysqladmin -u root -p ${SQL_ROOT_PASSWORD} shutdown
sleep 1

exec mysqld_safe